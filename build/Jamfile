# Copyright 2018 Peter Dimov
# Distributed under the Boost Software License, Version 1.0.
# (See accompanying file LICENSE_1_0.txt or copy at http://boost.org/LICENSE_1_0.txt)

import package ;
import path ;
import os ;
import option ;
import boostcpp ;
import sequence ;
import set ;
import ../../tools/boost-install ;

# install-requirements

local install-requirements ;

local layout = [ modules.peek boostcpp : layout ] ;
local BOOST_VERSION_TAG = [ modules.peek boostcpp : BOOST_VERSION_TAG ] ;

if $(layout) = versioned
{
    install-requirements += <install-header-subdir>boost-$(BOOST_VERSION_TAG) ;
}

local install-default-prefix ;

if [ os.name ] = NT
{
    install-default-prefix = C:/Boost ;
}
else
{
    install-default-prefix = /usr/local ;
}

install-requirements += <install-default-prefix>$(install-default-prefix) ;

# install-headers

# first, the 'modular' headers

local modular-headers = $(BOOST_MODULARLAYOUT) ;

local skip-headers ;

for local lib in $(modular-headers)
{
    local header-root = $(BOOST_ROOT)/libs/$(lib)/include/boost ;

    local headers =
        [ path.glob-tree $(header-root) : *.hpp *.ipp *.h *.inc ]
        [ path.glob-tree $(header-root)/compatibility/cpp_c_headers : c* ] ;

    skip-headers += [ sequence.transform path.relative-to [ path.make $(header-root) ] : $(headers) ] ;

    package.install install-$(lib)-headers boost
        : $(install-requirements)
          <install-source-root>$(header-root)
          <install-no-version-symlinks>on
        : # No binaries
        : # No libraries
        : $(headers)
    ;

    explicit install-$(lib)-headers ;
}

# then, the non-modular headers in boost/, minus the modular ones

local header-root = [ path.make $(BOOST_ROOT)/boost ] ;

local headers =
    [ path.glob-tree $(BOOST_ROOT)/boost : *.hpp *.ipp *.h *.inc ]
    [ path.glob-tree $(BOOST_ROOT)/boost/compatibility/cpp_c_headers : c* ] ;

headers = [ set.difference $(headers) : $(header-root)/$(skip-headers) ] ;

package.install install-boost-headers boost
    : $(install-requirements)
      <install-source-root>$(header-root)
      <install-no-version-symlinks>on
    : # No binaries
    : # No libraries
    : $(headers)
;

explicit install-boost-headers ;

#

alias install-headers : install-$(modular-headers)-headers install-boost-headers ;
explicit install-headers ;

# install-cmake-config

local prefix = [ option.get prefix : $(install-default-prefix) ] ;
local lib-locate = [ option.get libdir : $(prefix)/lib ] ;

alias boost_headers ;

boost-install.install-cmake-config $(lib-locate) : $(BOOST_VERSION) : boost_headers ;
explicit install-cmake-config ;

# install

alias install : install-headers install-cmake-config ;
explicit install ;

# stage

alias stage ;
explicit stage ;
